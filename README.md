﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿# Naraku**适合BI和OA系统的状态管理工具及数据可视化辅助工具包**  ***######## 名称由来《犬夜叉》中的BOSS奈落（ならく）的英文拼写。######## 特性简介 1. 在MVVM模式中，负责model-model的关系管理和model到viewModel的数据格式转换。   2. “简单粗暴”一招鲜式的解决方案：  无论具体使用什么渲染技术，都采用同一套方案，降低学习成本。   3. 对BI系统三大常见操作：级联、过滤、分组-聚合有良好支持  。 4. 对echarts有良好支持。#### #### 安装： ``npm install naraku@latest --save --registry=https://registry.npmjs.org`` 或 `` yarn add naraku@latest --registry=https://registry.npmjs.org``从npm源安装最新版#### #### 引入： ```//  DataHub 和 $Transform 是 naraku 的两个核心组件import { DataHub,  $Transform } from 'naraku';```## ##  DataHub组件   DataHub是一种Store组件。######### DataHub设计思想简介 1. 视图是数据的表现，数据变化则视图变化， 数据变化则触发事件。   2. 对于选择，可以视为从候选数据集里抽取一个或几个值，放到选中数据集。   3. 对于级联，可以通过监听父数据中选中值得变化，作出响应，获取数据  ，无论多少级，只需考虑父数据的变化即可。我们可以把这种级联关系视为一种依赖，既子数据依赖于选中的父数据，并且进一步泛化为多个依赖。除了级联关系，还可以通过监听数据变化的方式，自定义数据关系。   4. 每一种组件体系（VUE、React等）都有自己的组件通信方式和上下文管理，并且往往不止一种方式，增加了学习难度，DataHub本身可作为全局通信总线，因此可以通过DataHub通信和传递上下文，无视各种眼花缭乱的方法。为了便于通信，DataHub支持方法注册，效果等同于组件暴露出的公有方法。########## 主要用途：      1. 数据级联自动请求数据      2. 用于保存全局上下文信息      3. 用于组件间的通讯 ## ### 快速上手--在React中使用DataHub组件:```import React from 'react';import { DataHub,  $Transform } from 'naraku'; /*  示例场景：根据选中的省份，级联获取城市列表*//*==注册数据请求方法，在实际项目中通常是写在独立的文件中===*/// 获取省份列表APIDataHub.addFetcher('getProvince', (args)=>{  const {    param,  // 这个是请求参数，数据类型是Object    data, // 这个是提交的数据，数据类型是Array    form // 是否是表单数据集，数据类型Boolean } = args; // 实际项目中通常是异步请求数据  return [{name: '辽宁省'},{name: ‘浙江省’}];});// 获取城市列表APIDataHub.addFetcher('getCity', (args)=>{  const {    param,  // 这个是请求参数，数据类型是Object    data, // 这个是提交的数据，数据类型是Array    form // 是否是表单数据集，数据类型Boolean } = args;if (param.name === '辽宁省')  {  return [{name: '沈阳市'},{name: '大连市'}]}if (param.name === '浙江省')  {  return [{name: '杭州市'},{name: '宁波市'}]}  return []；});/*====================================*/// 通过DataHub.inject方法将DataHub注入到React组件中 （此方法也支持vue）@DataHub.inject({  // 参数是数据配置信息，用来配置数据直接的关系  // 获取城市列表  city: {  // city是数据集在DataHub中的名字     type:  'getCity',  // type是数据请求方法名     dependence: 'selectedProvince' // 依赖项：选中的省份，只有满足依赖后才会请求数据  },  // 获取省份列表  province: {  // province是数据集在DataHub中的名字    type:  'getProvince'      // 没有依赖项，因此当DataHub组件初始化以后自动请求数据  },  myData: { //  没有type，表示是本地数据    default: [{name: '张三'}]  //  default表示初始化数据  }})class NarakuDemo extends React.Component{  componentWillMount() {    // DataHub注入到React组件中，默认的变量名是dh（DataHub）;    console.log(this.dh);      // 同时生成的还有一个与组件生命周期相同的Controller，用于组件和dh的交互，当组件销毁时，Controller所有的方法失效    console.log(this.dhController);       // 读取数据集中的数据    console.log(this.dhController.get('myData'));   // 数据集中的数据将被统一封装成数组，读取不存在的数据集返回空数组    // 将数据写入数据集：选中的省份是浙江省，数据作为请求参数     this.dhController.set('selectedProvince', {name: '浙江省'}) // 此时满足了依赖条件DataHub请求数据，获取城市列表       // when函数用来监听数据集的数据变化，当数据变化时，触发回调,与事件不同的是如果在监听之前已有数据，将立即返回数据    this.dhController.when('city',  (data) => {      console.log(data)    });  } render() {  // 当数据和数据的状态发生变化时，自动重新渲染  console.log(this.dh.get('city));  //get等方法可以直接用dh对象调用  return null; }}```###### Controller的API方法 | 说明| 返回值|常见使用场景|示例|------|------|--------|---|----|when | 监听数据on | 监听事件once | 一次性监听数据load    |   异步获取数据，若已有数据，则立即返回，类似once    |   undefined     |all | 类似when，区别是当参数为数组时只要所有数据更新才会触发回调 | |fetch | 直接获取数据，不写入数据集 | |get| 读取数据集中的数据，若该数据集不存在，则返回空数组    | [] | 读取数用于展示的数据列表first|读取数据集中的第一条数据，若该数据不存在，则返回空对象   | {} | 读取全局状态/参数等数据refresh|   刷新数据集，重新请求数据（如果有type）| undefined | 提交表单后刷新列表submit|  提交数据| promise | 提交表单set|  写入数据| undefined | 操作数据assign0 | merge第一条数据，数据类型必须是Object       |   undefined      |  更新参数delete     |  删除数据     |   undefined      | emit    |  发射事件     |  undefined       | 触发事件snapshot     |   数据快照    |  undefined       | 对数据进行操作之前用于还原的数据reset     |  重置数据集     |   undefined      | 表单重置status     |  获取/改变数据状态     |   string     | loading     |    是否是loading状态   |  boolean      |  显示或隐藏加载界面ready     | 是否是ready状态      |   boolean           | 初始数据是否可用hasRunner| 执行者函数是否存在   | boolean        |register | 注册执行函数register | 注册函数run | 执行注册的函数#### Transformer组件  Transformer组件用于将数据转变为页面显示需要的格式 ，核心特性是**分组聚合**运算  主要用于业务模型到视图模型以及视图模型之间的格式转换，基准数据格式为数组对象  ###### 快速上手--使用Transformer组件:```import { DataHub,  $Transform } from 'naraku';// 用$开头的含义是可以像jQuery那样连续调用function(){return null;}```###方法 | 说明| 返回值|常见使用场景|示例|------|------|--------|---|----|fromObject | 从key-value结构转为对象数组toFields | 从对象数组的第一条数据中提取字段名toObject | 对象数组转为key-value结构operate | 自定义操作map | Array的map操作filter | Array的filter操作fromModel | 复杂模型转为数组对对象数组fromMatrix | 二维数组转为对象数组toMatrix | 对象数组转为二维数组fromTree | 树形结构转为自连接关系对象数组toTree |关系型对象数组转为树结构toGrouped | 分组聚合toSeries | echarts格式的分组聚合toNumSeries |  echarts折线、柱形图格式的分组聚合toPieSeries |echarts饼图格式的分组聚合toHeatSeries |echarts热力图格式的分组聚合toScatterSeries |echarts散点格式的分组聚合toRadarSeries |echarts雷达图的分组聚合getData|获得转换后的数据getRefs|获得转换过程中生成的反射信息output|获得转换后的数据和生成的反射信息#### 常用工具方法 | 说明| 返回值|常见使用场景|示例|------|------|--------|---|----|noValue|判断值是否为null或undefined|Booleanblank| 空函数 | undefinedblankNull| 空函数| nullsame|返回输入参数| anysnapshot| JSON对象快照| objectlocalBaseUrl|返回当前URL| stringupperCase0| 首字母大写 | stringNumberFormat.percent| 小数转为百分比|stringNumberFormat.thsepar| 添加千位分隔符| string##